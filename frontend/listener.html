<!doctype html>
<html>
  <head>
    <title>Listener</title>
  </head>
  <body>
    <audio id="audio" autoplay controls></audio>
    <script>
      const audio = document.getElementById("audio");
      const mediaSource = new MediaSource();
      audio.src = URL.createObjectURL(mediaSource);

      mediaSource.addEventListener("sourceopen", () => {
        const mime = "audio/webm;codecs=opus";
        const sourceBuffer = mediaSource.addSourceBuffer(mime);

        console.log("playing");

        fetch("/english").then((res) => {
          const reader = res.body.getReader();
          const pump = () =>
            reader.read().then(({ done, value }) => {
              if (done) return;
              console.log("received: ", value);
              sourceBuffer.appendBuffer(value);
              return pump();
            });
          return pump();
        });
      });
    </script>
  </body>
</html>
