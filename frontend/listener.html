<!doctype html>
<html>
  <head>
    <title>Audio Listener</title>
  </head>
  <body>
    <audio id="audio" controls></audio>
    <script>
      const audioElement = document.getElementById("audio");

      let pc = null;
      let ws = null;
      let isListening = false;
      let stream = null;

      async function startListening() {
        if (isListening) return;
        isListening = true;

        // Clean up from any previous session
        stopListening();

        pc = new RTCPeerConnection({
          iceServers: [],
        });

        ws = new WebSocket("/ws/listener".replace(/^http/, "ws"));

        ws.onopen = async () => {
          console.log("WebSocket connected");

          // Send a request to start listening (could be "offer" if needed)
          ws.send(
            JSON.stringify({
              type: "listen",
              data: {},
            }),
          );
        };

        ws.onmessage = async (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === "offer") {
            const offer = new RTCSessionDescription(msg.data);
            await pc.setRemoteDescription(offer);

            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);

            ws.send(
              JSON.stringify({
                type: "answer",
                data: answer,
              }),
            );
          } else if (msg.type === "ice") {
            await pc.addIceCandidate(new RTCIceCandidate(msg.data));
          } else if (msg.type === "speaker-connect") {
            console.log("Speaker connected");
            handleIncomingAudio(stream);
          } else if (msg.type === "speaker-disconnect") {
            console.log("Speaker disconnected");
            audioElement.pause();
          }
        };

        ws.onerror = (err) => {
          console.error("WebSocket error:", err);
          ws.close();
        };

        pc.onicecandidate = (event) => {
          if (event.candidate && ws?.readyState === WebSocket.OPEN) {
            ws.send(
              JSON.stringify({
                type: "ice",
                data: event.candidate,
              }),
            );
          }
        };

        pc.ontrack = (event) => {
          if (event.track.kind === "audio") {
            stream = event.streams[0];
            console.log("Audio track received: ", event.track);
            handleIncomingAudio(stream);
          }
        };
      }

      function handleIncomingAudio(stream) {
        console.log(stream);
        audioElement.srcObject = stream;
        audioElement
          .play()
          .catch((err) => console.error("Error playing audio:", err));
      }

      function stopListening() {
        if (pc) {
          pc.close();
          pc = null;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.close();
        }
        ws = null;
        isListening = false;
      }

      document.addEventListener("DOMContentLoaded", () => {
        startListening();
      });
    </script>
  </body>
</html>
